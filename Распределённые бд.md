**Практическое занятие №5: «Построение распределённых БД в MSSMS»**  
**Цель:** Настроить распределённую БД между локальным сервером (студента) и центральным сервером (L17-PC01).  
**Продолжительность:** 4 академических часа.  

---

### **Блок 1. Подготовка среды (20 минут)**  
1. **Адресация:**  
   - Локальный сервер студента: **L17-PC{X}** (где **X** — номер компьютера, например, L17-PC2).  
   - Центральный сервер: **L17-PC01** (управляется преподавателем, доступен для всех).  
2. **Проверка соединения:**  
   - Убедитесь, что в MSSMS доступны оба сервера:  
     ```sql  
     -- Проверка доступности вашего сервера  
     SELECT @@SERVERNAME; -- На вашем локальном сервере  
     -- Проверка доступности глобал сервера
     ping L17-PC01
     ```  
   - Если L17-PC01 недоступен, значит Саня(тех админ, не я) снова насрал в штаны

---

### **Блок 2. Практические задания (200 минут)**  

#### **Задача 1. Настройка Linked Server (40 минут)**  
**Цель:** Связать локальный сервер (L17-PC{X}) с центральным (L17-PC01).  
**Шаги:**  
1. Создайте Linked Server на вашем локальном сервере для доступа к L17-PC01:  
   ```sql  
   EXEC sp_addlinkedserver  
   @server = 'CentralServer', -- Название для центрального сервера  
   @srvproduct = 'SQL Server',  
   @provider = 'SQLNCLI',  
   @datasrc = 'L17-PC01';  
   ```  
2. Проверьте подключение:  
   ```sql  
   SELECT * FROM CentralServer.master.sys.databases;  
   ```  

#### **Задача 2. Создание распределённой таблицы (60 минут)**  
**Цель:** Создать таблицу `LocalOrders` на локальном сервере и синхронизировать её с центральной БД.  
**Шаги:**  
1. На локальном сервере создайте таблицу:  
   ```sql  
   CREATE TABLE LocalOrders (  
       OrderID INT PRIMARY KEY,  
       ProductName NVARCHAR(50),  
       OrderDate DATETIME,  
       ClientID INT  
   );  
   ```  
2. На центральном сервере (L17-PC01) создайте таблицу `GlobalOrders` с такой же структурой.  
3. Настройте репликацию с локального сервера на центральный:  
   - Используйте **SQL Server Replication Wizard** (правая кнопка на БД → Replication → Configure Distribution).  

#### **Задача 3. Шардирование данных (50 минут)**  
**Цель:** Разделить таблицу `LocalOrders` по диапазону дат (2023 и 2024 годы).  
**Шаги:**  
1. Создайте функцию партиционирования:  
   ```sql  
   CREATE PARTITION FUNCTION OrdersByYear (DATETIME)  
   AS RANGE RIGHT FOR VALUES ('2024-01-01');  
   ```  
2. Примените партиционирование к таблице `LocalOrders`.  
3. Перенесите партиции за 2024 год на центральный сервер:  
   ```sql  
   -- Пример запроса к CentralServer  
   INSERT INTO CentralServer.RestaurantDB.dbo.GlobalOrders  
   SELECT * FROM LocalOrders WHERE OrderDate >= '2024-01-01';  
   ```  

#### **Задача 4. Распределённые транзакции (40 минут)**  
**Цель:** Добавить заказ в локальную и центральную БД в одной транзакции.  
**Шаги:**  
1. Выполните транзакцию:  
   ```sql  
   BEGIN DISTRIBUTED TRANSACTION;  
   -- Добавление в локальную БД  
   INSERT INTO LocalOrders VALUES (101, 'Стейк', GETDATE(), 5);  
   -- Добавление в центральную БД  
   INSERT INTO CentralServer.RestaurantDB.dbo.GlobalOrders  
   VALUES (101, 'Стейк', GETDATE(), 5);  
   COMMIT TRANSACTION;  
   ```  
2. Проверьте данные на обоих серверах.  

#### **Задача 5. Резервное копирование (10 минут)**  
**Цель:** Создать резервную копию локальной БД и отправить её на L17-PC01.  
```sql  
BACKUP DATABASE LocalDB TO DISK = 'C:\Backup\LocalDB.bak';  
-- Переместите файл на L17-PC01 через общую сетевую папку.  
```  

---

### **Блок 3. Тестирование и отчёт (20 минут)**  
1. **Проверка Linked Server:**  
   - Выполните запрос к CentralServer:  
     ```sql  
     SELECT COUNT(*) FROM CentralServer.RestaurantDB.dbo.GlobalOrders;  
     ```  
2. **Проверка репликации:**  
   - Добавьте строку в `LocalOrders` и убедитесь, что она появилась в `GlobalOrders` на L17-PC01.  
3. **Отчёт:**  
   - Приложите скриншоты:  
     - Настройки Linked Server.  
     - Успешного выполнения распределённой транзакции.  
     - Данных в CentralServer.  

---

### **Дополнительные задания**  
1. **Вертикальное шардирование:**  
   - Разделите таблицу `Menu` на `MenuItems` (название, цена) и `MenuDetails` (калорийность, состав), разместив части на разных серверах.  
2. **Автоматизация:**  
   - Напишите триггер, который при добавлении заказа в `LocalOrders` автоматически копирует его в `GlobalOrders`.  

---

### **Критерии оценки**  
- **5 баллов:** Все скрипты работают, данные синхронизированы между серверами.  
- **4 балла:** Есть незначительные ошибки в репликации.  
- **3 балла:** Linked Server настроен, но транзакции не выполнены.  

В случае, если сервак не поднимется, задание резко меняется на другое, и мы уходим без оценок

**Файлы для сдачи(pdf):**  
- Скрины настройки Linked Server, партиционирования, транзакций.  
- Скриншоты работы системы.  
- Резервная копия БД.  

---

**Важно:**  
- Если L17-PC01 недоступен, используйте скил нытья и не пытайтесь разобраться! Как говорится, гугл придумали дураки для таких же
- Все запросы к CentralServer должны включать имя `CentralServer` (например, `CentralServer.Database.dbo.Table`).
